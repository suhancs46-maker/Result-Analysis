<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Template</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style2.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            padding-bottom: 60px; /* Add space for fixed footer */
        }

        .tamplatetable{
    height: 400px;
    width: 100%;
    padding-left: 80px;

   }
        
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }
        
        /* Excel Editor Modal */
        #excelEditorModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            overflow: auto;
        }
        
        #excelEditorContent {
            background: white;
            margin: 20px auto;
            padding: 20px;
            width: 95%;
            max-width: 1400px;
            border-radius: 8px;
            max-height: 90vh;
            overflow: auto;
        }
        
        #excelEditorContent h2 {
            margin-top: 0;
            color: #333;
        }
        
        #excelEditorContent table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        #excelEditorContent table th,
        #excelEditorContent table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        #excelEditorContent table th {
            background-color: #4CAF50;
            color: white;
        }
        
        #excelEditorContent input[type="text"] {
            width: 100%;
            border: none;
            padding: 5px;
            font-size: 14px;
        }
        
        .editor-buttons {
            margin: 20px 0;
            text-align: right;
        }
        
        .editor-buttons button {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="navbar2">
        <img src="navbar.jpeg" alt="">
    </div>
    <br><br>
    <!-- data -->
    <div class="data">
        <h3>5 SEMESTER E&C MINI PROJECT-2025-26</h3>
        <h1>EXAMINATION RESULT ANALYSIS</h1>
    </div>

    <div class="formContainer">

    <div class="newtemplate">
        <h2 style="font-weight: 800;">Download Template:</h2>
        <form action="" id="searchForm">
            <div class="form-group">
                <label for="searchInput">Search Template:</label>
                <input type="text" id="searchInput" name="searchInput" placeholder="Search by academic year, branch, or semester" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <br>
            <div class="form-group">
                <button type="button" onclick="searchTemplates()" style="background: #0078D7; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">SEARCH</button>
                <button type="button" onclick="clearSearch()" style="background: #6c757d; color: white; padding: 10px 30px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px;">CLEAR</button>
            </div>
        </form>
    </div>
    </div>
    <br>
    <br>

    <div class="tamplatetable">

        <table border="1" id="templateTable">
        <tr>
            <th style="width: 10%;">T.N</th>
            <th style="width: 40%;">Template Name</th>
            <th style="width: 50%;">Action</th>
        </tr>
        <tbody id="templateTableBody">
            <!-- Templates will be loaded here dynamically -->
        </tbody>
    </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // Load templates from localStorage
        function loadTemplates(filterCriteria = null) {
            const savedTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
            const tbody = document.getElementById('templateTableBody');
            
            let filteredTemplates = savedTemplates;
            
            // Apply filters if provided
            if (filterCriteria) {
                filteredTemplates = savedTemplates.filter(template => {
                    let matches = true;
                    
                    if (filterCriteria.academicYear) {
                        matches = matches && template.academicYear.toLowerCase().includes(filterCriteria.academicYear.toLowerCase());
                    }
                    
                    if (filterCriteria.branch) {
                        matches = matches && template.branch.toLowerCase().includes(filterCriteria.branch.toLowerCase());
                    }
                    
                    if (filterCriteria.semester) {
                        matches = matches && template.semester === filterCriteria.semester;
                    }
                    
                    return matches;
                });
            }
            
            if (filteredTemplates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 20px; color: #666;">
                            ${filterCriteria ? 'No templates found matching your search criteria.' : 'No templates available. Create a new template to get started.'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            let rowNumber = 1;
            
            // If search is active, show matching templates first, then others
            if (filterCriteria) {
                // Get all templates
                const allTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
                
                // Separate matching and non-matching templates
                const matchingTemplates = filteredTemplates;
                const nonMatchingTemplates = allTemplates.filter(t => 
                    !filteredTemplates.some(ft => ft.id === t.id)
                );
                
                // Display matching templates first
                matchingTemplates.forEach((template) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>
                            <strong>${template.fileName}</strong><br>
                            <small style="color: #333;">
                                ${template.academicYear} | ${template.branch} | Sem ${template.semester}<br>
                                Created: ${template.createdDate} ${template.createdTime}
                            </small>
                        </td>
                        <td>
                            <table class="action-table" border="1">
                                <tr>
                                    <td class="download">
                                        <button onclick="downloadTemplate(${template.id})">DOWNLOAD</button>
                                    </td>
                                    <td class="edit">
                                        <button onclick="editTemplate(${template.id})" style="background: #28a745; color: white;">EDIT</button>
                                    </td>
                                    <td class="delete">
                                        <button onclick="deleteTemplate(${template.id})">DELETE</button>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    `;
                    tbody.appendChild(row);
                    rowNumber++;
                });
                
                // Display non-matching templates below
                nonMatchingTemplates.forEach((template) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>
                            <strong>${template.fileName}</strong><br>
                            <small style="color: #333;">
                                ${template.academicYear} | ${template.branch} | Sem ${template.semester}<br>
                                Created: ${template.createdDate} ${template.createdTime}
                            </small>
                        </td>
                        <td>
                            <table class="action-table" border="1">
                                <tr>
                                    <td class="download">
                                        <button onclick="downloadTemplate(${template.id})">DOWNLOAD</button>
                                    </td>
                                    <td class="edit">
                                        <button onclick="editTemplate(${template.id})" style="background: #28a745; color: white;">EDIT</button>
                                    </td>
                                    <td class="delete">
                                        <button onclick="deleteTemplate(${template.id})">DELETE</button>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    `;
                    tbody.appendChild(row);
                    rowNumber++;
                });
            } else {
                // No search filter - display all templates normally
                filteredTemplates.forEach((template) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>
                            <strong>${template.fileName}</strong><br>
                            <small style="color: #333;">
                                ${template.academicYear} | ${template.branch} | Sem ${template.semester}<br>
                                Created: ${template.createdDate} ${template.createdTime}
                            </small>
                        </td>
                        <td>
                            <table class="action-table" border="1">
                                <tr>
                                    <td class="download">
                                        <button onclick="downloadTemplate(${template.id})">DOWNLOAD</button>
                                    </td>
                                    <td class="edit">
                                        <button onclick="editTemplate(${template.id})" style="background: #28a745; color: white;">EDIT</button>
                                    </td>
                                    <td class="delete">
                                        <button onclick="deleteTemplate(${template.id})">DELETE</button>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    `;
                    tbody.appendChild(row);
                    rowNumber++;
                });
            }
        }
        
        // Search templates
        function searchTemplates() {
            const searchInput = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchInput) {
                alert('Please enter a search term');
                return;
            }
            
            const templates = JSON.parse(localStorage.getItem('excelTemplates') || '[]');
            
            // Separate matching and non-matching templates
            const matchingTemplates = [];
            const nonMatchingTemplates = [];
            
            templates.forEach(template => {
                const searchText = `${template.academicYear} ${template.branch} ${template.semester}`.toLowerCase();
                if (searchText.includes(searchInput)) {
                    matchingTemplates.push(template);
                } else {
                    nonMatchingTemplates.push(template);
                }
            });
            
            // Display matching templates first with green background
            displayTemplates(matchingTemplates, nonMatchingTemplates);
        }
        
        // Display templates with matching ones highlighted
        function displayTemplates(matchingTemplates, nonMatchingTemplates) {
            const tbody = document.getElementById('templateTableBody');
            tbody.innerHTML = '';
            
            let serialNumber = 1;
            
            // Display matching templates with green background
            matchingTemplates.forEach(template => {
                const row = document.createElement('tr');
                row.style.backgroundColor = '#90EE90'; // Light green
                
                row.innerHTML = `
                    <td style="text-align: center;">${serialNumber++}</td>
                    <td>
                        <strong>${template.name}</strong><br>
                        <small style="color: #555;">
                            ${template.academicYear} | ${template.branch} | Sem ${template.semester}<br>
                            Created: ${template.createdAt}
                        </small>
                    </td>
                    <td>
                        <table class="action-table" border="1">
                            <tr>
                                <td class="download">
                                    <button onclick="downloadTemplate(${template.id})">DOWNLOAD</button>
                                </td>
                                <td class="edit">
                                    <button onclick="editTemplate(${template.id})" style="background: #28a745; color: white;">EDIT</button>
                                </td>
                                <td class="delete">
                                    <button onclick="deleteTemplate(${template.id})">DELETE</button>
                                </td>
                            </tr>
                        </table>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Display non-matching templates normally
            nonMatchingTemplates.forEach(template => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td style="text-align: center;">${serialNumber++}</td>
                    <td>
                        <strong>${template.name}</strong><br>
                        <small style="color: #555;">
                            ${template.academicYear} | ${template.branch} | Sem ${template.semester}<br>
                            Created: ${template.createdAt}
                        </small>
                    </td>
                    <td>
                        <table class="action-table" border="1">
                            <tr>
                                <td class="download">
                                    <button onclick="downloadTemplate(${template.id})">DOWNLOAD</button>
                                </td>
                                <td class="edit">
                                    <button onclick="editTemplate(${template.id})" style="background: #28a745; color: white;">EDIT</button>
                                </td>
                                <td class="delete">
                                    <button onclick="deleteTemplate(${template.id})">DELETE</button>
                                </td>
                            </tr>
                        </table>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (matchingTemplates.length === 0 && nonMatchingTemplates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">No templates found</td></tr>';
            }
        }
        
        // Clear search and show all templates
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            loadTemplates();
        }
        
        // Download template
        function downloadTemplate(templateId) {
            const savedTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
            const template = savedTemplates.find(t => t.id === templateId);
            
            if (!template) {
                alert('Template not found!');
                return;
            }
            
            // Convert array back to Uint8Array
            const uint8Array = new Uint8Array(template.blobData);
            const blob = new Blob([uint8Array], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            // Download
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = template.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            
            alert(`✅ Template downloaded: ${template.fileName}`);
        }
        
        // Delete template
        function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) {
                return;
            }
            
            let savedTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
            savedTemplates = savedTemplates.filter(t => t.id !== templateId);
            localStorage.setItem('examTemplates', JSON.stringify(savedTemplates));
            
            loadTemplates();
            alert('✅ Template deleted successfully!');
        }
        
        // Edit template
        let currentEditingTemplate = null;
        let currentEditingData = null;
        
        function editTemplate(templateId) {
            const savedTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
            const template = savedTemplates.find(t => t.id === templateId);
            
            if (!template) {
                alert('Template not found!');
                return;
            }
            
            currentEditingTemplate = template;
            
            // Convert array back to Uint8Array and create workbook
            const uint8Array = new Uint8Array(template.blobData);
            const workbook = XLSX.read(uint8Array, { type: 'array' });
            
            // Display the Excel data in modal
            displayExcelInBrowser(workbook, template.fileName);
        }
        
        function displayExcelInBrowser(workbook, fileName) {
            const container = document.getElementById('excelDataContainer');
            container.innerHTML = '';
            
            currentEditingData = workbook;
            
            // Display each sheet
            workbook.SheetNames.forEach((sheetName, index) => {
                const worksheet = workbook.Sheets[sheetName];
                
                // Create sheet header
                const sheetHeader = document.createElement('h3');
                sheetHeader.textContent = `Sheet: ${sheetName}`;
                sheetHeader.style.marginTop = index > 0 ? '30px' : '10px';
                container.appendChild(sheetHeader);
                
                // Convert sheet to HTML table
                const htmlTable = XLSX.utils.sheet_to_html(worksheet, { 
                    id: `sheet_${index}`,
                    editable: true 
                });
                
                const tableDiv = document.createElement('div');
                tableDiv.innerHTML = htmlTable;
                
                // Make cells editable
                const table = tableDiv.querySelector('table');
                if (table) {
                    table.querySelectorAll('td').forEach(cell => {
                        const currentValue = cell.textContent;
                        cell.innerHTML = `<input type="text" value="${currentValue}" />`;
                    });
                }
                
                container.appendChild(tableDiv);
            });
            
            // Show modal
            document.getElementById('excelEditorModal').style.display = 'block';
        }
        
        function closeExcelEditor() {
            document.getElementById('excelEditorModal').style.display = 'none';
            currentEditingTemplate = null;
            currentEditingData = null;
        }
        
        function saveEditedTemplate() {
            if (!currentEditingTemplate || !currentEditingData) {
                alert('No template to save!');
                return;
            }
            
            try {
                // Collect edited data from all sheets
                const container = document.getElementById('excelDataContainer');
                const sheets = container.querySelectorAll('table');
                
                currentEditingData.SheetNames.forEach((sheetName, index) => {
                    const table = sheets[index];
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        const data = [];
                        
                        rows.forEach(row => {
                            const rowData = [];
                            row.querySelectorAll('td, th').forEach(cell => {
                                const input = cell.querySelector('input');
                                rowData.push(input ? input.value : cell.textContent);
                            });
                            data.push(rowData);
                        });
                        
                        // Update worksheet with edited data
                        currentEditingData.Sheets[sheetName] = XLSX.utils.aoa_to_sheet(data);
                    }
                });
                
                // Generate updated Excel file
                const excelBuffer = XLSX.write(currentEditingData, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                // Update template in localStorage
                let savedTemplates = JSON.parse(localStorage.getItem('examTemplates') || '[]');
                const templateIndex = savedTemplates.findIndex(t => t.id === currentEditingTemplate.id);
                
                if (templateIndex !== -1) {
                    savedTemplates[templateIndex].blobData = Array.from(new Uint8Array(excelBuffer));
                    savedTemplates[templateIndex].createdDate = new Date().toLocaleDateString('en-IN');
                    savedTemplates[templateIndex].createdTime = new Date().toLocaleTimeString('en-IN');
                    localStorage.setItem('examTemplates', JSON.stringify(savedTemplates));
                }
                
                // Download edited file
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = currentEditingTemplate.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                alert('✅ Template updated and downloaded successfully!');
                closeExcelEditor();
                loadTemplates(); // Refresh the template list
                
            } catch (error) {
                console.error('Error saving edited template:', error);
                alert('❌ Error saving template: ' + error.message);
            }
        }
        
        // Load templates on page load
        window.addEventListener('DOMContentLoaded', loadTemplates);
    </script>

    <!-- Excel Editor Modal -->
    <div id="excelEditorModal">
        <div id="excelEditorContent">
            <h2>Edit Template</h2>
            <div class="editor-buttons">
                <button class="btn-save" onclick="saveEditedTemplate()">SAVE & DOWNLOAD</button>
                <button class="btn-close" onclick="closeExcelEditor()">CLOSE</button>
            </div>
            <div id="excelDataContainer"></div>
        </div>
    </div>

     <footer>
    <span class="copy">Copyright ©️ 2025.All rights reserved. Developed by under Skill Lab @E&C, KVGCE</span>
    <br>
    <span class="dpdBy"> Developed By: 
      <a href="https://www.linkedin.com/in/basavaraju-r-k-055843300?utm_source=share_via&utm_content=profile&utm_medium=member_android" target="_blank" style="color: #0077b5; text-decoration: none;">Basavaraju R K</a>, 
      <a href="https://www.linkedin.com/in/suhan-cs-2bb003301?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" style="color: #0077b5; text-decoration: none;">Suhan C S</a>
  </footer>
</body>
</html>